name: Deploy API to AWS Lambda

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.12.1

      - name: PNPM config
        run: |
          # Enable injecting workspace packages in pnpm, needed for pnpm deploy command
          pnpm config set inject-workspace-packages=true --location project
          # Hack to keep lock file check happy
          yq -i '.settings.injectWorkspacePackages = true' pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prepare deployment package
        run: |
          pnpm build --filter=api
          pnpm --filter=api --prod deploy ./api-deploy
          cd ./api-deploy
          mv ./dist/* .
          rmdir ./dist

      - name: Clean up deployment directory
        run: |
          cd ./api-deploy
          rm -rf ./src
          find . -name "*.ts" -type f -delete
          find . -name "*.map" -type f -delete
          echo "üßπ Cleaned up deployment directory"

      - name: Smoke test - Start built API
        run: |
          cd ./api-deploy
          timeout 10s node index.js &
          SERVER_PID=$!

          # Wait for server to start
          echo "‚è≥ Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3001/health > /dev/null 2>&1; then
              echo "‚úÖ Server started successfully!"
              curl -s http://localhost:3001/health | jq .
              kill $SERVER_PID 2>/dev/null || true
              exit 0
            fi
            sleep 1
          done

          echo "‚ùå Server failed to start"
          kill $SERVER_PID 2>/dev/null || true
          exit 1

      - name: Package deployment zip
        run: |
          cd ./api-deploy
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ZIP_FILE="lambda-deployment-${TIMESTAMP}.zip"
          zip -r -q "$ZIP_FILE" .
          echo "ZIP_FILE=${ZIP_FILE}" >> $GITHUB_ENV
          echo "üì¶ Created deployment package: $ZIP_FILE ($(du -h "$ZIP_FILE" | cut -f1))"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get Lambda configuration from AWS Secrets Manager
        id: lambda-config
        run: |
          LAMBDA_BUCKET=$(aws secretsmanager get-secret-value --secret-id pack-pixie/lambda-bucket --query SecretString --output text)
          LAMBDA_FUNCTION=$(aws secretsmanager get-secret-value --secret-id pack-pixie/lambda-function --query SecretString --output text)
          echo "bucket=${LAMBDA_BUCKET}" >> $GITHUB_OUTPUT
          echo "function=${LAMBDA_FUNCTION}" >> $GITHUB_OUTPUT

      - name: Upload to S3
        run: |
          aws s3 cp ./api-deploy/${{ env.ZIP_FILE }} s3://${{ steps.lambda-config.outputs.bucket }}/${{ env.ZIP_FILE }}
          echo "‚òÅÔ∏è Uploaded to S3"

      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.lambda-config.outputs.function }} \
            --s3-bucket ${{ steps.lambda-config.outputs.bucket }} \
            --s3-key ${{ env.ZIP_FILE }} \
            --publish

      - name: Wait for Lambda to be ready
        run: |
          aws lambda wait function-updated \
            --function-name ${{ steps.lambda-config.outputs.function }}
          echo "‚úÖ Lambda function updated successfully!"

      - name: Get API Gateway URL from AWS Secrets Manager
        run: |
          API_URL=$(aws secretsmanager get-secret-value --secret-id pack-pixie/api-gateway-url --query SecretString --output text 2>/dev/null || echo "")
          if [ -n "$API_URL" ]; then
            echo "üåê API Gateway URL: ${API_URL}"
            echo "Testing endpoints:"
            echo "  Health: ${API_URL}/health"
            echo "  Status: ${API_URL}/api/status"
            echo "  Hello:  ${API_URL}/api/hello"
          fi
